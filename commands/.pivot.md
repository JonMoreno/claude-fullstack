# Pivot to Feature Worktree

Kill dev servers, close old iTerm tabs, and restart servers in a feature worktree using iTerm hotwindow tabs.

## Usage
```
/pivot <feature>
/pivot permissions        # fuzzy match
/pivot mail               # fuzzy match
/pivot 310-permissions    # exact match
```

## Instructions

### Step 1: Detect Workspace Context

Determine workspace root and base project name from current working directory:

**Scenario A - Inside a worktree:**
```
cwd: /path/to/workspace/myproject-client-123-feature

Parse folder name with pattern: {base}-{app}-{feature}
  → base: myproject
  → app: client
  → current_feature: 310-permissions
  → workspace_root: parent directory (/path/to/workspace)
```

**Scenario B - At workspace root:**
```
cwd: /path/to/workspace

Scan children for pattern {name}-{app}-{feature}
  → Detect base from common prefix (myproject)
  → workspace_root: cwd
```

**Scenario C - Elsewhere:**
```
Look for .claude/workspace.json with explicit workspace_root
Or prompt user for workspace path
```

### Step 2: Find Matching Worktrees

Scan workspace_root for directories matching the feature argument:

```bash
# Fuzzy match: find dirs containing the feature string
ls -d ${workspace_root}/${base}-*-*${feature}* 2>/dev/null
```

**Match priority:**
1. Exact match: `myproject-api-310-permissions` matches `310-permissions`
2. Fuzzy match: `myproject-api-310-permissions` matches `permissions`
3. If multiple features match (e.g., "3" matches both "310" and "302"), use AskUserQuestion to let user select

**If no feature argument provided OR multiple matches:**
Use the `AskUserQuestion` tool to let user select interactively:

```
AskUserQuestion:
  question: "Which feature do you want to pivot to?"
  header: "Feature"
  options:
    - label: "216-mail"
      description: "API + Client"
    - label: "310-permissions"
      description: "API + Client"
    - label: "302-single-access-role"
      description: "Client only"
```

**Important:** If feature argument is provided and matches exactly one feature, do NOT ask - just proceed.

### Step 2.5: Create Worktrees (if not found)

If NO matching worktrees are found for the feature, offer to create them:

**Use AskUserQuestion to confirm:**
```
AskUserQuestion:
  question: "No worktrees found for '{feature}'. Create them?"
  header: "Create"
  options:
    - label: "Yes, create worktrees"
      description: "Creates git worktrees from develop"
    - label: "No, cancel"
      description: "Abort pivot"
```

**If user confirms, ask which apps to create:**
```
AskUserQuestion:
  question: "Which repos to create worktrees for?"
  header: "Repos"
  options:
    - label: "Both (Recommended)"
      description: "Create api + client worktrees"
    - label: "API only"
      description: "Create myproject-api-{feature} only"
    - label: "Client only"
      description: "Create my-client-{feature} only"
```

**Then create worktrees for selected repos:**

```bash
# Configuration (auto-detected from Step 1)
BASE_BRANCH="develop"
BRANCH_NAME="feature/${feature}"  # e.g., feature/320-new-feature
# WORKSPACE_ROOT is detected dynamically from cwd (see Step 1)

# Create API worktree
cd ${WORKSPACE_ROOT}/myproject-api
git fetch origin
git worktree add ../${base}-api-${feature} -b ${BRANCH_NAME} origin/${BASE_BRANCH}

# Create Client worktree
cd ${WORKSPACE_ROOT}/my-client
git fetch origin
git worktree add ../${base}-client-${feature} -b ${BRANCH_NAME} origin/${BASE_BRANCH}
```

**Branch naming:** `feature/{ticket-number}-{description}`
**Base branch:** `develop`

### Step 2.6: Setup New Worktrees

After creating worktrees, run setup commands:

**Laravel (API) setup:**
```bash
cd ${WORKSPACE_ROOT}/${base}-api-${feature}

# Copy .env from main repo
cp ${WORKSPACE_ROOT}/myproject-api/.env .env

# Install dependencies
composer install

# Generate app key
php artisan key:generate

# Clear config cache
php artisan config:clear
```

**Next.js (Client) setup:**
```bash
cd ${WORKSPACE_ROOT}/${base}-client-${feature}

# Copy .env.local from main repo
cp ${WORKSPACE_ROOT}/my-client/.env.local .env.local

# Install dependencies
npm install
```

### Step 2.7: Migrations (Ask + Remember)

For Laravel migrations, check workspace.json for saved preference:

```json
// .claude/workspace.json
{
  "migrations": "ask" | "yes" | "no"
}
```

**If preference not saved, use AskUserQuestion:**
```
AskUserQuestion:
  question: "Run database migrations?"
  header: "Migrate"
  options:
    - label: "Yes, run migrations"
      description: "php artisan migrate"
    - label: "No, skip"
      description: "Skip migrations"
    - label: "Always yes for this project"
      description: "Remember: always run migrations"
    - label: "Always no for this project"
      description: "Remember: never run migrations"
```

**If "Always yes/no" selected, save to workspace.json for future runs.**

```bash
# If yes or "always yes"
php artisan migrate
```

**After setup, continue with Step 3.**

### Step 3: Default to "both" Apps

**Do NOT ask which app to pivot** - default to pivoting ALL matching apps.

- If both api and client worktrees exist → pivot both
- If only one exists → pivot that one
- Only ask if there's ambiguity in the FEATURE match (e.g., multiple features match the query)

### Step 4: Detect Project Types (for start commands)

For each matched directory, detect project type if not configured:

| Files Present | Type | Port | Start Command |
|---------------|------|------|---------------|
| `composer.json` + `artisan` | Laravel | 8000 | `php artisan serve` |
| `package.json` + `next.config.*` | Next.js | 3000 | `npm run dev` |
| `package.json` + `vite.config.*` | Vite | 5173 | `npm run dev` |

### Step 5: Kill Ports

Kill processes on the relevant ports:

```bash
lsof -ti:8000 | xargs kill -9 2>/dev/null || true
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
```

### Step 6: Open Tabs in Current iTerm Window

Open new tabs in the current iTerm window (hotkey window or regular):

**IMPORTANT:** If using hotkey window, make sure it's **visible** (Cmd+]) before running /pivot.

```bash
osascript <<EOF
tell application "iTerm"
  activate
  delay 0.3

  tell current window
    -- First new tab: API
    create tab with default profile
    tell current session
      write text "cd ${api_worktree_path} && php artisan serve"
    end tell

    -- Second new tab: Client
    create tab with default profile
    tell current session
      write text "cd ${client_worktree_path} && npm run dev"
    end tell
  end tell
end tell
EOF
```

**Note:** Uses `current window` directly - works with hotkey window when visible.

### Step 7: Report Results

```
Killed ports: 8000, 3000

Opened tabs in current iTerm:
  Tab: myproject-api-310-permissions → :8000
  Tab: myproject-client-123-feature → :3000

Pivoted to permissions
```

---

## Optional Config

Place at workspace root: `{workspace_root}/.claude/workspace.json`

```json
{
  "base": "myproject",
  "workspace_root": "/path/to/workspace",
  "apps": {
    "api": {
      "port": 8000,
      "start": "php artisan serve",
      "pattern": "{base}-api-{feature}"
    },
    "client": {
      "port": 3000,
      "start": "npm run dev",
      "pattern": "{base}-client-{feature}"
    }
  }
}
```

If config exists, use it. Otherwise auto-detect everything.

---

## Examples

**From inside a worktree:**
```
cwd: ~/Dev/Project/my-client-216-mail
> /pivot permissions

Detected: workspace=~/Dev/Project, base=myproject
Found: myproject-api-310-permissions, myproject-client-123-feature
Pivoting both...

Done. Pivoted to permissions.
```

**Ambiguous feature match:**
```
> /pivot 3

Multiple features match "3":
  [1] 310-permissions
  [2] 302-single-access-role

Which feature? > 1

Pivoting to 310-permissions...
```

**Single app match:**
```
> /pivot single-access

Found: my-client-302-single-access-role (client only)
Pivoting client...

Done.
```

**Create new worktrees (full flow):**
```
> /pivot 320-new-feature

No worktrees found for '320-new-feature'.

Create worktrees? [Yes, create worktrees] [No, cancel]
> Yes

Which repos? [Both (Recommended)] [API only] [Client only]
> Both

Creating worktrees from develop...
  ✓ git worktree add ../myproject-api-320-new-feature -b feature/320-new-feature
  ✓ git worktree add ../my-client-320-new-feature -b feature/320-new-feature

Setting up API (Laravel)...
  ✓ cp .env from main repo
  ✓ composer install
  ✓ php artisan key:generate
  ✓ php artisan config:clear

Setting up Client (Next.js)...
  ✓ cp .env.local from main repo
  ✓ npm install

Run database migrations? [Yes] [No] [Always yes] [Always no]
> Always no

Saved preference: migrations = no

Pivoting...
  ✓ Killed ports: 8000, 3000
  ✓ Opened iTerm tabs

Pivoted to 320-new-feature
```
