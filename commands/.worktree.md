#!/bin/bash

# Function to print colored messages
print_error() {
    printf "\033[0;31m✗ Error: %s\033[0m\n" "$1" >&2
}

print_success() {
    printf "\033[0;32m✓ %s\033[0m\n" "$1"
}

print_info() {
    printf "\033[0;34mℹ %s\033[0m\n" "$1"
}

print_warning() {
    printf "\033[1;33m⚠ %s\033[0m\n" "$1"
}

print_bold() {
    printf "\033[1m%s\033[0m" "$1"
}

# Parse parameters
ticket=$(echo "$1" | tr '[:upper:]' '[:lower:]') # Convert to lowercase
description="$2"

# Validate parameters
if [[ -z "$ticket" ]] || [[ -z "$description" ]]; then
    print_error "Missing required parameters"
    print_bold "Usage:"
    printf " /.worktree {ticket} {description}\n"
    print_bold "Example:"
    printf " /.worktree proj-123 user-profile-feature\n"
    exit 1
fi

# Validate ticket format (should be lowercase with hyphens and numbers)
if ! [[ "$ticket" =~ ^[a-z0-9-]+$ ]]; then
    print_error "Ticket must be lowercase with only letters, numbers, and hyphens"
    print_bold "Example:"
    printf " proj-123, bug-456, feature-42\n"
    exit 1
fi

# Validate description format (kebab-case)
if ! [[ "$description" =~ ^[a-z0-9-]+$ ]]; then
    print_error "Description must be in kebab-case (lowercase with hyphens)"
    print_bold "Example:"
    printf " user-profile-feature, api-rate-limiting\n"
    exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    echo "Please navigate to a git repository before running this command"
    exit 1
fi

# Get repository information
repo_root=$(git rev-parse --show-toplevel)
repo_name=$(basename "$repo_root")

# Construct paths and names
# Use worktrees subdirectory for better organization
# Allow override via environment variable WORKTREE_BASE_DIR
if [[ -n "$WORKTREE_BASE_DIR" ]]; then
    # Use custom location from environment variable
    worktree_path="${WORKTREE_BASE_DIR}/${repo_name}-${ticket}-${description}"
    # Create base directory if it doesn't exist before using realpath
    mkdir -p "${WORKTREE_BASE_DIR}"
    absolute_worktree_path=$(cd "${WORKTREE_BASE_DIR}" && pwd)/"${repo_name}-${ticket}-${description}"
    worktree_dir="${WORKTREE_BASE_DIR}"
else
    # Default: Use worktrees subdirectory inside the repo
    worktree_path="./worktrees/${ticket}-${description}"
    absolute_worktree_path="${repo_root}/worktrees/${ticket}-${description}"
    worktree_dir="${repo_root}/worktrees"
fi

branch_name="feature/${ticket}-${description}"

# Create worktrees directory if it doesn't exist
if [[ ! -d "${worktree_dir}" ]]; then
    print_info "Creating worktrees directory at ${worktree_dir}..."
    mkdir -p "${worktree_dir}"
fi

print_info "Setting up worktree for ticket: "
print_bold "$ticket"
printf "\n"
printf "  Repository: "
print_bold "$repo_name"
printf "\n  Branch: "
print_bold "$branch_name"
printf "\n  Location: "
print_bold "$worktree_path"
printf "\n\n"

# Check if worktree already exists
if git worktree list | grep -q "${absolute_worktree_path}"; then
    print_error "Worktree already exists at ${worktree_path}"
    echo ""
    echo "Options:"
    echo "  1. Navigate to existing worktree:"
    printf "     "
    print_bold "cd ${worktree_path}"
    printf "\n"
    echo "  2. Remove existing worktree first:"
    printf "     "
    print_bold "git worktree remove ${worktree_path}"
    printf "\n"
    echo "  3. Use a different ticket number"
    exit 1
fi

# Check if branch already exists
if git show-ref --verify --quiet "refs/heads/${branch_name}"; then
    print_warning "Branch '${branch_name}' already exists"
    echo "Creating worktree with existing branch..."
    branch_exists=true
else
    branch_exists=false
fi

# Determine base branch
base_branch=""
if git show-ref --verify --quiet refs/heads/develop; then
    base_branch="develop"
elif git show-ref --verify --quiet refs/heads/main; then
    base_branch="main"
elif git show-ref --verify --quiet refs/heads/master; then
    base_branch="master"
else
    # Use current branch as fallback
    base_branch=$(git branch --show-current)
    if [[ -z "$base_branch" ]]; then
        print_error "Could not determine base branch"
        exit 1
    fi
fi

print_info "Base branch: "
print_bold "$base_branch"
printf "\n"
echo ""

# Create the worktree
printf "\033[0;34mCreating worktree...\033[0m\n"
if [[ "$branch_exists" == true ]]; then
    # Use existing branch
    if ! git worktree add "${worktree_path}" "${branch_name}"; then
        print_error "Failed to create worktree with existing branch"
        exit 1
    fi
else
    # Create new branch
    if ! git worktree add "${worktree_path}" -b "${branch_name}" "${base_branch}"; then
        print_error "Failed to create worktree"
        echo "Git error output is shown above"
        exit 1
    fi
fi

echo ""
print_success "Worktree created successfully!"
print_success "Location: ${worktree_path}"
print_success "Branch: ${branch_name}"

# Change to the new worktree directory
echo ""
print_info "Changing to worktree directory..."
cd "${absolute_worktree_path}" || {
    print_warning "Could not change directory automatically"
    printf "Please run: "
    print_bold "cd ${worktree_path}"
    printf "\n"
    exit 0
}

# Show final status
echo ""
printf "\033[0;32m\033[1m=== Setup Complete ===\033[0m\n"
printf "Working directory: "
print_bold "$(pwd)"
printf "\nBranch: "
print_bold "$(git branch --show-current)"
printf "\nStatus: "
print_bold "$(git status --short --branch | head -1)"
printf "\n\n"
printf "\033[0;34mNext steps:\033[0m\n"
echo "  1. Start developing your feature"
echo "  2. Commit changes as needed"
printf "  3. Push branch when ready: "
print_bold "git push -u origin ${branch_name}"
printf "\n"
echo "  4. Create PR when complete"
echo ""
printf "\033[1;33mCleanup:\033[0m When done, remove with: "
print_bold "git worktree remove ${worktree_path}"
printf "\n"
echo ""
print_info "Note: All worktrees are now stored in the './worktrees/' subdirectory"
echo "This keeps them organized and ensures they survive folder restructuring."