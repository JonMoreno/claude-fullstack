# Cleanup Workspace

You need to safely remove a feature workspace after checking for code quality and uncommitted changes. Follow these steps:

## 1. Get the ticket ID
Check if ticket ID was provided in command arguments (e.g., "proj-123").
If NO ticket ID provided:
- First, list available features from project/feature-* directories
- Then use AskUserQuestion tool to let user select which feature to cleanup
- Show the available features as options with their status (clean/has changes)

IMPORTANT: Continue with the process after getting the ticket ID - don't stop!

## 2. Load Configuration
Find the workspace config file (.claude/workspace-config.json).
Use jq or bash to extract:
- Project root
- Repository names
- Ports to cleanup

## 3. Validate Feature Directory
Check if feature-<ticket-id> directory exists.
If not, inform user there's nothing to clean up.

## 4. Code Quality Review (Before Cleanup)
Before removing the workspace, perform a quick code quality audit:

### 4A: Check for Cleanup Items
For each repository worktree, look for:
```bash
# Console logs left behind
grep -rn "console\.log\|console\.warn\|console\.error" --include="*.ts" --include="*.tsx" src/ | head -20

# TODO/FIXME comments
grep -rn "TODO\|FIXME\|XXX\|HACK" --include="*.ts" --include="*.tsx" --include="*.php" . | head -20

# Commented-out code blocks (rough check)
grep -rn "^[[:space:]]*//.*function\|^[[:space:]]*//.*const\|^[[:space:]]*//.*return" --include="*.ts" --include="*.tsx" . | head -10
```

Show findings with emojis:
- ğŸ§¹ Found X console.log statements
- ğŸ“ Found X TODO/FIXME comments
- ğŸ’¬ Found X potential commented-out code blocks
- âœ… No cleanup items found

### 4B: Check for Code Issues
Run quick checks (if tools available):
```bash
# TypeScript errors (client)
cd client-feature-* && npm run type-check 2>&1 | tail -20

# PHP linting (api)
cd api-feature-* && ./vendor/bin/phpstan analyse --memory-limit=512M 2>&1 | tail -20
```

Show status:
- âŒ X type errors found
- âš ï¸ X linting warnings
- âœ… No code issues detected

### 4C: Flag Potential Refactors
Quick scan for code smells:
```bash
# Large files (>500 lines)
find . -name "*.ts" -o -name "*.tsx" -o -name "*.php" | xargs wc -l | sort -rn | head -5

# Duplicate function names (rough check)
grep -rh "function \w\+\|const \w\+ = \(.*\) =>" --include="*.ts" --include="*.tsx" . | sort | uniq -d | head -10
```

Show findings:
- ğŸ“Š Large files that may need splitting
- ğŸ”„ Potential duplicate code patterns
- âœ… No obvious refactor needed

### 4D: Verify Business Logic
Check that changes align with existing patterns and specs:

```bash
# Find modified/new files in the feature branch
git diff --name-only main...HEAD | head -30

# Check for related spec file
ls -la .claude/specs/ 2>/dev/null || echo "No specs directory"

# Look for existing similar implementations to compare patterns
# Example: If adding a new service, check existing services
grep -rn "class.*Service" --include="*.php" app/Services/ | head -10
grep -rn "export.*function\|export.*const" --include="*.ts" src/services/ | head -10
```

Review checklist:
- ğŸ“‹ Does implementation match the feature spec (if exists)?
- ğŸ”„ Does it follow existing patterns in the codebase?
- ğŸ”— Are there related files that should also be updated?
- âš ï¸ Any breaking changes to existing APIs/interfaces?

Show findings:
- ğŸ“‹ Spec found: `specs/<feature>.md` - Compare against implementation
- ğŸ”„ Pattern check: Similar to existing `X` implementation
- âš ï¸ Potential gaps: Files modified but related files not updated
- âœ… Business logic appears consistent

If spec exists, cross-reference:
- Are all spec requirements implemented?
- Any deviations from the spec that need documentation?

### 4E: Present Quality Report
Display a summary table:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CODE QUALITY REPORT - feature-<ticket-id>                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ§¹ Cleanup Items:    X console.logs, Y TODOs               â”‚
â”‚  âŒ Code Issues:      X type errors, Y lint warnings        â”‚
â”‚  ğŸ“Š Refactor Flags:   X large files, Y duplicates           â”‚
â”‚  ğŸ“‹ Business Logic:   [Matches spec âœ… | Gaps found âš ï¸]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Overall: [CLEAN âœ… | NEEDS ATTENTION âš ï¸ | ISSUES âŒ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

If issues found, use AskUserQuestion:
- "Code quality issues detected. How would you like to proceed?"
- Options:
  - "Continue with cleanup" (acknowledge and proceed)
  - "Fix issues first" (pause cleanup, show file locations)
  - "Cancel cleanup" (exit)

## 5. Safety Checks
For each repository worktree, check:
- Uncommitted changes (git diff)
- Staged changes (git diff --cached)
- Untracked files (git ls-files --others)

Show status with emojis:
- âš ï¸ Has uncommitted changes
- âœ… Repository is clean

## 6. Confirm Cleanup
If changes exist:
- Use AskUserQuestion tool to confirm deletion
- Warn that changes will be LOST
- Suggest committing or stashing first

If no changes:
- Use AskUserQuestion to confirm removal

## 7. Cleanup Process (Proper Worktree Removal!)
If user confirms, follow these steps IN ORDER:

### Step 7A: Stop Running Servers
Stop any running servers on configured ports:
```bash
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
lsof -ti:8000 | xargs kill -9 2>/dev/null || true
```

### Step 7B: Verify Worktrees Exist in Git
Before removing, check if git knows about these worktrees:
```bash
git -C /main-repo worktree list | grep feature-<ticket-id>
```

### Step 7C: Remove Worktrees Properly
For EACH repo:
```bash
# Try to remove worktree
git -C /main-repo worktree remove /path/to/feature/repo --force

# If that fails (corrupted), prune and try again
if [ $? -ne 0 ]; then
  git -C /main-repo worktree prune
  git -C /main-repo worktree remove /path/to/feature/repo --force 2>/dev/null || true
fi
```

Show progress:
- `âœ… Removed worktree: api-feature-[name] (my-api)`
- `âš ï¸ Worktree already removed: client-feature-[name] (my-client)`

### Step 7D: Clean Up Git Worktree Metadata
After removing worktrees, clean up any stale entries:
```bash
git -C /main-repo worktree prune
```

### Step 7E: Delete Feature Directory
```bash
rm -rf /path/to/feature-<ticket-id>
```

**Note:** This removes:
- All worktree directories (api-feature-*, client-feature-*)
- Installation log files (if any remain)
- The `.code-workspace` file
- Any other feature-specific files

### Step 7F: Handle Branches
**IMPORTANT:** Ask user about branches!

Use AskUserQuestion:
- "Delete local branches too? (feature/hq-[name] in both repos)"
- Options:
  - "Keep branches" (default - branches stay for reference)
  - "Delete branches" (removes branches completely)

If user chooses "Delete branches":
```bash
git -C /main-repo branch -D feature/hq-<ticket-id>-<name>
```

Show: `âœ… Deleted branch: feature/hq-<ticket-id>-<name>` or `â„¹ï¸ Kept branches`

## 8. Display Summary
Show cleanup results:
- âœ¨ Cleanup complete!
- âœ… Removed: feature-<ticket-id> workspace (including .code-workspace file)
- âœ… Removed: Git worktrees (api-feature-<ticket-id>, client-feature-<ticket-id>)
- âœ… Stopped: All dev servers
- âœ… Cleaned: Git worktree metadata (pruned)
- â„¹ï¸ Branches: [Kept/Deleted] based on user choice

**If worktrees were already removed:**
- âš ï¸ Some worktrees were already removed or corrupted
- âœ… Cleaned up stale git metadata

If user is in deleted directory, suggest: `cd /project/root`

## Important UX Guidelines:
- Show clear progress with emojis
- Use AskUserQuestion for confirmations, not bash read
- No Python scripts - use jq or bash
- Provide helpful context about what will be deleted
- Always offer escape routes (cancel option)
- VERIFY worktrees exist in `git worktree list` before removing
- ALWAYS run `git worktree prune` to clean up stale entries
- Handle corrupted worktrees gracefully (try remove, if fails then prune and retry)
- ASK about branch deletion - don't assume user wants to keep/delete
- Show clear feedback: "Removed" vs "Already removed" vs "Cleaned up"
- If worktree remove fails, don't fail the whole cleanup - continue with directory deletion